<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vimeo Theater Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://player.vimeo.com/api/player.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        #playerContainer {
            position: relative;
            width: 70vw;
            height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            box-shadow: 0 0 80px rgba(0,0,0,0.9);
        }

        #videoPlayer {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #videoIframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Bottom Control Bar - Clean horizontal layout */
        .bottom-controls {
            position: absolute;
            bottom: -50px;
            left: 0;
            right: 0;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
        }

        /* Countdown Timer - Bottom Left */
        .countdown-timer {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            white-space: nowrap;
        }

        /* Video Title - Next to timer */
        .video-title-display {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 20px;
            flex: 1;
            text-align: left;
        }

        /* Next Button - Far Right */
        .next-button {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-weight: 900;
            transition: color 0.2s;
            margin-left: 20px;
        }

        .next-button:hover {
            color: #667eea;
        }

        .video-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            display: none; /* Hide this - we only want the bottom title */
        }

        #playerContainer:hover .video-info {
            opacity: 1;
        }

        .video-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .video-meta {
            font-size: 14px;
            opacity: 0.8;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 40px;
            border-radius: 12px;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        /* Reshuffling indicator */
        .reshuffle-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 30px 50px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .reshuffle-message.show {
            opacity: 1;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220,38,38,0.9);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
        }

        .error-message h2 {
            margin-bottom: 15px;
        }

        .error-message p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .error-message button {
            background: white;
            color: #dc2626;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="playerContainer">
        <video id="videoPlayer" style="display: none;"></video>
        <iframe id="videoIframe" style="display: none;" allowfullscreen></iframe>
        
        <div class="video-info">
            <div class="video-title" id="currentTitle">Loading...</div>
            <div class="video-meta" id="currentMeta">Preparing playback...</div>
        </div>

        <!-- Bottom Control Bar -->
        <div class="bottom-controls">
            <div class="countdown-timer" id="countdownTimer">0:00</div>
            <div class="video-title-display" id="videoTitleDisplay"></div>
            <button class="next-button" id="nextButton" onclick="playNext()">▶</button>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>Loading videos...</div>
        </div>

        <!-- Reshuffle indicator -->
        <div class="reshuffle-message" id="reshuffleMessage">
            <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
            <div>Reshuffling playlist...</div>
        </div>
    </div>

    <script>
        let videos = [];
        let shuffledPlaylist = [];
        let currentPlaylistIndex = 0;
        let hasStartedPlaying = false;
        let hls = null;
        let countdownInterval = null;
        const videoPlayer = document.getElementById('videoPlayer');
        const videoIframe = document.getElementById('videoIframe');
        const loading = document.getElementById('loading');
        const countdownTimer = document.getElementById('countdownTimer');
        const reshuffleMessage = document.getElementById('reshuffleMessage');

        // Initialize player
        function initPlayer() {
            // Small delay to ensure localStorage is fully available
            setTimeout(() => {
                loadFromLocalStorage();
                
                if (videos.length > 0) {
                    console.log('Loaded videos:', videos);
                    console.log('Original order:', videos.map((v, i) => `${i}: ${v.id}`));
                    
                    // Create shuffled playlist
                    shuffledPlaylist = shuffleArray([...Array(videos.length).keys()]);
                    console.log('Shuffled order:', shuffledPlaylist);
                    console.log('First video to play:', shuffledPlaylist[0], videos[shuffledPlaylist[0]]);
                    
                    currentPlaylistIndex = 0;
                    playVideo(shuffledPlaylist[currentPlaylistIndex]);
                } else {
                    console.error('No videos found in localStorage');
                    showError();
                }
            }, 100);
        }

        // Load playlist from localStorage
        function loadFromLocalStorage() {
            try {
                const playlistData = localStorage.getItem('videoStreamPlaylist-vimeo');
                console.log('Raw localStorage data:', playlistData);
                
                if (playlistData) {
                    videos = JSON.parse(playlistData);
                    console.log('Parsed videos:', videos);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        // Format time for countdown (mm:ss)
        function formatCountdown(seconds) {
            if (!seconds || seconds < 0) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Update countdown timer
        function updateCountdown(currentTime, duration) {
            const remaining = duration - currentTime;
            countdownTimer.textContent = formatCountdown(remaining);
        }

        // Shuffle array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Play video by index
        async function playVideo(videoIndex) {
            if (videoIndex < 0 || videoIndex >= videos.length) return;
            
            const video = videos[videoIndex];
            console.log('Playing video:', video);
            
            // Clear any existing countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Only show loading on first video
            if (currentPlaylistIndex === 0 && !hasStartedPlaying) {
                loading.style.display = 'flex';
                hasStartedPlaying = true;
            }
            
            // Reset countdown
            countdownTimer.textContent = '0:00';
            
            // Update video info display at top (hover only)
            document.getElementById('currentTitle').textContent = video.name || `Video ${videoIndex + 1}`;
            document.getElementById('currentMeta').textContent = `${currentPlaylistIndex + 1} of ${videos.length}`;
            
            // Fetch title and duration from Vimeo - WAIT for it if duration is missing
            if (video.id && !video.duration) {
                console.log('Duration missing, fetching from Vimeo...');
                await fetchVimeoTitle(video.id);
            } else if (video.id) {
                // Fetch title in background (don't wait)
                fetchVimeoTitle(video.id);
            }
            
            // Determine video type - prioritize iframeUrl for Vimeo
            if (video.iframeUrl) {
                playIframeVideo(video.iframeUrl, video.duration);
            } else if (video.hlsUrl) {
                playHLSVideo(video.hlsUrl);
            } else if (video.url) {
                // Fallback to url field
                if (video.url.includes('.m3u8')) {
                    playHLSVideo(video.url);
                } else if (video.url.includes('iframe') || video.url.includes('vimeo.com')) {
                    playIframeVideo(video.url, video.duration);
                } else {
                    playDirectVideo(video.url);
                }
            } else {
                console.error('No valid video URL found:', video);
                playNext();
            }
        }

        // Fetch video title and duration from Vimeo oEmbed API (more reliable than v2 API)
        async function fetchVimeoTitle(videoId) {
            try {
                // Use oEmbed API - more reliable than v2 API
                const response = await fetch(`https://vimeo.com/api/oembed.json?url=https://vimeo.com/${videoId}`);
                const data = await response.json();
                
                if (data) {
                    // Set title
                    if (data.title) {
                        document.getElementById('videoTitleDisplay').textContent = data.title;
                        console.log('Fetched title:', data.title);
                        
                        // Update stored name
                        if (videos[shuffledPlaylist[currentPlaylistIndex]]) {
                            videos[shuffledPlaylist[currentPlaylistIndex]].name = data.title;
                        }
                    }
                    
                    // Store duration if available
                    if (data.duration && videos[shuffledPlaylist[currentPlaylistIndex]]) {
                        videos[shuffledPlaylist[currentPlaylistIndex]].duration = data.duration;
                        console.log('Fetched duration from oEmbed:', data.duration);
                    }
                }
            } catch (error) {
                console.error('Error fetching Vimeo metadata:', error);
                document.getElementById('videoTitleDisplay').textContent = '';
            }
        }

        // Play HLS video
        function playHLSVideo(url) {
            console.log('Playing HLS:', url);
            videoPlayer.style.display = 'block';
            videoIframe.style.display = 'none';
            
            if (hls) {
                hls.destroy();
            }
            
            if (Hls.isSupported()) {
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true
                });
                
                hls.loadSource(url);
                hls.attachMedia(videoPlayer);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    loading.style.display = 'none';
                    videoPlayer.play();
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        console.error('HLS error:', data);
                        playNext();
                    }
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                videoPlayer.src = url;
                loading.style.display = 'none';
                videoPlayer.play();
            }
            
            // Update countdown timer
            videoPlayer.ontimeupdate = () => {
                if (videoPlayer.duration) {
                    updateCountdown(videoPlayer.currentTime, videoPlayer.duration);
                }
            };
            
            videoPlayer.onended = () => {
                playNext();
            };
        }

        // Play iframe video
        async function playIframeVideo(url, estimatedDuration) {
            console.log('Playing iframe:', url);
            videoPlayer.style.display = 'none';
            videoIframe.style.display = 'block';
            
            // Clear any existing countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Add autoplay and loop=0 parameters
            const separator = url.includes('?') ? '&' : '?';
            const autoplayUrl = `${url}${separator}autoplay=1&loop=0&muted=0`;
            
            videoIframe.src = autoplayUrl;
            loading.style.display = 'none';
            
            // Get actual duration from stored video data (fetched from Vimeo API)
            const currentVideo = videos[shuffledPlaylist[currentPlaylistIndex]];
            const actualDuration = currentVideo?.duration || estimatedDuration;
            
            console.log('Using duration:', actualDuration, 'seconds');
            
            // ALWAYS start manual countdown as backup
            // This ensures countdown works even if Player API events fail
            if (actualDuration && actualDuration > 0) {
                startManualCountdown(actualDuration);
            }
            
            // Also try Player API for more accurate updates (if it works, it will override manual)
            setTimeout(() => {
                if (window.Vimeo && window.Vimeo.Player) {
                    try {
                        const player = new Vimeo.Player(videoIframe);
                        console.log('Vimeo Player API initialized');
                        
                        let playerApiWorking = false;
                        
                        // Try to use player API for accuracy
                        player.on('timeupdate', function(data) {
                            playerApiWorking = true;
                            updateCountdown(data.seconds, data.duration);
                        });
                        
                        player.on('ended', function() {
                            if (countdownInterval) clearInterval(countdownInterval);
                            playNext();
                        });
                        
                        // Check after 3 seconds if Player API is working
                        setTimeout(() => {
                            if (!playerApiWorking) {
                                console.warn('Player API timeupdate not firing, manual countdown will continue');
                            } else {
                                console.log('Player API working, using for accurate updates');
                            }
                        }, 3000);
                        
                    } catch (e) {
                        console.error('Vimeo Player API error:', e);
                    }
                }
            }, 500);
        }

        // Start manual countdown that always works
        function startManualCountdown(duration) {
            if (!duration || duration <= 0) {
                console.error('Invalid duration for countdown:', duration);
                return;
            }
            
            console.log('Starting manual countdown for', duration, 'seconds');
            countdownTimer.textContent = formatCountdown(duration);
            let elapsed = 0;
            
            countdownInterval = setInterval(() => {
                elapsed += 1;
                const remaining = duration - elapsed;
                countdownTimer.textContent = formatCountdown(remaining);
                
                if (elapsed >= duration) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    playNext();
                }
            }, 1000);
        }

        // Play direct video
        function playDirectVideo(url) {
            console.log('Playing direct:', url);
            videoPlayer.style.display = 'block';
            videoIframe.style.display = 'none';
            
            videoPlayer.src = url;
            loading.style.display = 'none';
            videoPlayer.play();
            
            videoPlayer.ontimeupdate = () => {
                if (videoPlayer.duration) {
                    updateCountdown(videoPlayer.currentTime, videoPlayer.duration);
                }
            };
            
            videoPlayer.onended = () => {
                playNext();
            };
        }

        // Play next video in shuffled playlist
        function playNext() {
            currentPlaylistIndex++;
            
            if (currentPlaylistIndex >= shuffledPlaylist.length) {
                // All videos played - reshuffle and continue!
                reshuffleAndContinue();
                return;
            }
            
            playVideo(shuffledPlaylist[currentPlaylistIndex]);
        }

        // Reshuffle playlist and continue playing
        function reshuffleAndContinue() {
            // Show reshuffle message
            reshuffleMessage.classList.add('show');
            videoPlayer.style.display = 'none';
            videoIframe.style.display = 'none';
            
            // Wait 2 seconds with message, then reshuffle
            setTimeout(() => {
                // Create new shuffled playlist
                shuffledPlaylist = shuffleArray([...Array(videos.length).keys()]);
                currentPlaylistIndex = 0;
                
                // Hide message and start playing
                reshuffleMessage.classList.remove('show');
                playVideo(shuffledPlaylist[currentPlaylistIndex]);
            }, 2000);
        }

        // Show error message
        function showError() {
            loading.style.display = 'none';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h2>⚠️ No Videos Found</h2>
                <p>No videos were loaded from the admin panel. Please go back to the admin panel and select videos to play.</p>
                <button onclick="window.close()">Close Player</button>
            `;
            document.getElementById('playerContainer').appendChild(errorDiv);
        }

        // Initialize on load
        window.addEventListener('load', initPlayer);
    </script>
</body>
</html>

